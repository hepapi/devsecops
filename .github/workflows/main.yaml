name: Full Pipeline

on:
  push:
    branches:
      - main

env:
  image_name: hepapi/devsecops
  image_tag: ${{ github.sha }}

jobs:
  scan-dockerfile-build-image:
    uses: ./.github/workflows/docker-build.yaml

  neuvector-scan:
    uses: ./.github/workflows/neuvector-scan.yml
    needs: scan-dockerfile-build-image
    with:
      image_name: ${{ env.image_name }}
      image_tag: ${{ env.image_tag }}

  mend-scan:
    uses: ./.github/workflows/mend-scan.yaml
    needs: scan-dockerfile-build-image
    with:
      image_name: ${{ env.image_name }}
      image_tag: ${{ env.image_tag }}

  trivy-scan:
    uses: ./.github/workflows/trivy-image-scan.yaml
    needs: scan-dockerfile-build-image
    with:
      image_name: ${{ env.image_name }}
      image_tag: ${{ env.image_tag }}

  push-image:
    uses: ./.github/workflows/push-image.yaml
    needs: [neuvector-scan, mend-scan, trivy-scan]
    with:
      image_name: ${{ env.image_name }}
      image_tag: ${{ env.image_tag }}
