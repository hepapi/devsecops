name: Mend Scan

on:
  workflow_call:

env:
  REGISTRY: docker.io
  IMAGE_NAME: hepapi/devsecops

jobs:
  scan-image-with-mend:
    runs-on: ubuntu-latest
    steps:

      - name: Mend CLI Scan
        env:
          MEND_EMAIL: ${{secrets.MEND_EMAIL}}
          MEND_USER_KEY: ${{secrets.MEND_USER_KEY}}
          MEND_URL: https://saas-eu.mend.io
        run: |
          echo Downloading Mend CLI
          curl https://downloads.mend.io/cli/linux_amd64/mend -o /usr/local/bin/mend && chmod +x /usr/local/bin/mend
          echo run Mend dependencies scan
          mend dep -u -s *//hepapi//devsecops
          echo Run Mend code scan
          mend code -s *//hepapi//devsecops
          echo Run Mend Image Scan
          mend image ${{ env.IMAGE_NAME }}:${{ github.sha }} --format sarif --filename mend-results.sarif --local-pull -s "*//hepapi//devsecops"

      - name: Upload Mend SARIF Report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'mend-results.sarif'
          category: mend
